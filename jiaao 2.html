<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>嘉澳环保 SAF 利润测算器 </title>
    
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 引入 React 和 ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 引入 Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 引入 Lucide 图标 -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f8fafc; 
            -webkit-tap-highlight-color: transparent;
        }
        /* 自定义滑块样式 */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #ffffff;
            border: 2px solid #4f46e5;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            margin-top: -10px; 
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #e2e8f0;
            border-radius: 2px;
        }
        .orange-slider::-webkit-slider-thumb {
            border: 2px solid #f97316;
        }
        .purple-slider::-webkit-slider-thumb {
            border: 2px solid #9333ea;
        }

        /* --- 新增：隐藏 input type=number 的默认上下箭头 --- */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield; /* Firefox */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { Calculator, BarChart3, Settings, AlertCircle, TrendingUp, DollarSign, RefreshCw, Calendar, Fuel } = lucide;

        const JiaaoSafCalculator = () => {
            // --- 核心参数状态 (State) ---
            const [safPriceUsd, setSafPriceUsd] = useState(2100); // SAF FOB美元售价
            const [ucoPriceRmb, setUcoPriceRmb] = useState(6300); // UCO人民币价格
            const [naphthaPriceRmb, setNaphthaPriceRmb] = useState(7000); // 新增：生物石脑油价格
            const [exchangeRate, setExchangeRate] = useState(7.1); // 汇率
            const [yieldRate, setYieldRate] = useState(74.6); // 转化率
            const [processCost, setProcessCost] = useState(2500); // 加工成本
            const [taxFactor, setTaxFactor] = useState(1.07); // 综合税率系数
            const [equityRatio, setEquityRatio] = useState(53.55); // 归母权益比例
            
            // 市值与股价联动状态
            const TOTAL_SHARES = 0.76825886; 
            const [marketCap, setMarketCap] = useState(63.00); 
            const [sharePrice, setSharePrice] = useState(82.00); 

            // 固定产量参数 (万吨) - 根据用户提供数据更新
            // SAF: 37.3万吨, 石脑油: 4.3万吨
            const volumeYearly = 37.3; 
            const volumeMonthly = volumeYearly / 12; 
            const volumeQuarterly = volumeYearly / 4; 
            
            // 产出比例: 每吨SAF伴生多少吨石脑油
            const NAPHTHA_RATIO = 4.3 / 37.3; 

            // --- 计算结果状态 ---
            const [results, setResults] = useState({
                safRevenueOnly: 0,
                naphthaCredit: 0,
                grossCostPerTon: 0,
                netCostPerTon: 0, // 净成本 (扣除副产品后)
                grossProfitPerTon: 0,
                marginRate: 0,
                monthlyProjectProfit: 0, 
                quarterlyProjectProfit: 0, 
                annualProjectProfit: 0, 
                attributableProfit: 0,   
                peRatio: 0,
            });

            // --- 联动处理函数 ---
            const handleMarketCapChange = (val) => {
                setMarketCap(val);
                setSharePrice(val / TOTAL_SHARES);
            };

            const handleSharePriceChange = (val) => {
                setSharePrice(val);
                setMarketCap(val * TOTAL_SHARES);
            };

            useEffect(() => {
                setSharePrice(marketCap / TOTAL_SHARES);
                if (window.lucide) window.lucide.createIcons();
            }, []);

            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            });

            // --- 核心计算逻辑 ---
            useEffect(() => {
                // 1. 单吨收入 (纯SAF)
                const safRevenue = safPriceUsd * exchangeRate;
                
                // 2. 副产品收益 (作为成本抵扣 Credit)
                // 每吨SAF对应产生的石脑油价值
                const naphthaCredit = naphthaPriceRmb * NAPHTHA_RATIO;

                // 3. 原料成本
                const unitConsumption = 1 / (yieldRate / 100);
                const rawMaterialCost = ucoPriceRmb * unitConsumption;

                // 4. 单吨完全成本 (Gross) = (原料成本 + 加工成本) * 综合税率
                const baseCost = rawMaterialCost + processCost;
                const totalGrossCost = baseCost * taxFactor; 

                // 5. 单吨净成本 (Net) = 完全成本 - 副产品抵扣
                const netCost = totalGrossCost - naphthaCredit;

                // 6. 单吨毛利 = SAF纯收入 - 净成本
                const profitPerTon = safRevenue - netCost;
                const margin = (profitPerTon / safRevenue) * 100;

                // 7. 项目层面总利润 (亿元)
                const monthlyProfitVal = (profitPerTon * volumeMonthly * 10000) / 100000000; 
                const quarterlyProfitVal = (profitPerTon * volumeQuarterly * 10000) / 100000000; 
                const annualProfitVal = (profitPerTon * volumeYearly * 10000) / 100000000; 

                // 8. 归母净利润
                const attributableVal = annualProfitVal * (equityRatio / 100);

                // 9. 动态PE
                const pe = attributableVal > 0 ? marketCap / attributableVal : 0;

                setResults({
                    safRevenueOnly: safRevenue,
                    naphthaCredit: naphthaCredit,
                    grossCostPerTon: totalGrossCost,
                    netCostPerTon: netCost,
                    grossProfitPerTon: profitPerTon,
                    marginRate: margin,
                    monthlyProjectProfit: monthlyProfitVal,
                    quarterlyProjectProfit: quarterlyProfitVal,
                    annualProjectProfit: annualProfitVal,
                    attributableProfit: attributableVal,
                    peRatio: pe,
                });
            }, [safPriceUsd, ucoPriceRmb, naphthaPriceRmb, exchangeRate, yieldRate, processCost, taxFactor, equityRatio, marketCap]);

            const fmt = (num, fixed = 0) => num.toLocaleString('zh-CN', { minimumFractionDigits: fixed, maximumFractionDigits: fixed });

            return (
                <div className="max-w-6xl mx-auto min-h-screen pb-10">
                    
                    {/* 顶部导航与估值区 */}
                    <div className="bg-white shadow-sm sticky top-0 z-50 border-b border-slate-200">
                        <div className="p-4 max-w-6xl mx-auto flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div>
                                <h1 className="text-xl font-bold text-slate-900 flex items-center gap-2">
                                    <i data-lucide="calculator" className="w-6 h-6 text-indigo-600"></i>
                                    嘉澳环保 SAF 利润测算器
                                </h1>
                            </div>
                            
                            {/* 股价/市值输入 */}
                            <div className="flex items-center gap-2 bg-slate-50 p-2 rounded-lg border border-slate-200">
                                <div className="flex flex-col items-end">
                                    <label className="text-[10px] text-slate-400 font-medium">股价(元)</label>
                                    <input 
                                        type="number" 
                                        value={sharePrice.toFixed(2)} 
                                        onChange={(e) => handleSharePriceChange(Number(e.target.value))}
                                        className="w-20 text-right font-bold text-lg text-slate-700 bg-transparent outline-none border-b border-transparent focus:border-indigo-500 transition-colors"
                                    />
                                </div>
                                <div className="text-slate-300"><i data-lucide="refresh-cw" className="w-4 h-4"></i></div>
                                <div className="flex flex-col items-end">
                                    <label className="text-[10px] text-slate-400 font-medium">市值(亿)</label>
                                    <input 
                                        type="number" 
                                        value={marketCap.toFixed(2)} 
                                        onChange={(e) => handleMarketCapChange(Number(e.target.value))}
                                        className="w-16 text-right font-bold text-lg text-indigo-600 bg-transparent outline-none border-b border-transparent focus:border-indigo-500 transition-colors"
                                    />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="p-4 grid grid-cols-1 lg:grid-cols-12 gap-6">
                        
                        {/* 左侧：控制面板 */}
                        <div className="lg:col-span-5 space-y-4">
                            <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                                <div className="flex items-center gap-2 mb-4 text-base font-semibold text-slate-700">
                                    <i data-lucide="settings" className="w-4 h-4"></i>
                                    核心变量设置
                                </div>

                                {/* SAF 售价 */}
                                <div className="space-y-3 mb-6">
                                    <div className="flex justify-between items-center">
                                        <label className="text-sm font-bold text-indigo-900">SAF 出口售价 ($)</label>
                                        <div className="flex items-center gap-1">
                                            {/* -100 按钮 */}
                                            <button onClick={() => setSafPriceUsd(p => p - 100)} className="h-8 px-2 flex items-center justify-center bg-red-50 text-red-600 border border-red-100 rounded-lg text-xs font-bold hover:bg-red-100 active:scale-95 transition">-100</button>
                                            <button onClick={() => setSafPriceUsd(p => p - 10)} className="w-8 h-8 flex items-center justify-center bg-slate-100 rounded-lg text-slate-600 hover:bg-slate-200 active:scale-95 transition">-</button>
                                            
                                            <input 
                                                type="number" step="10" 
                                                value={safPriceUsd} 
                                                onChange={(e) => setSafPriceUsd(Number(e.target.value))}
                                                className="w-16 text-center py-1 font-bold text-lg text-indigo-600 bg-indigo-50 rounded-lg outline-none"
                                            />
                                            
                                            <button onClick={() => setSafPriceUsd(p => p + 10)} className="w-8 h-8 flex items-center justify-center bg-slate-100 rounded-lg text-slate-600 hover:bg-slate-200 active:scale-95 transition">+</button>
                                            {/* +100 按钮 */}
                                            <button onClick={() => setSafPriceUsd(p => p + 100)} className="h-8 px-2 flex items-center justify-center bg-green-50 text-green-600 border border-green-100 rounded-lg text-xs font-bold hover:bg-green-100 active:scale-95 transition">+100</button>
                                        </div>
                                    </div>
                                    <input 
                                        type="range" min="1500" max="3000" step="10" 
                                        value={safPriceUsd} 
                                        onChange={(e) => setSafPriceUsd(Number(e.target.value))}
                                        className="w-full mt-2"
                                    />
                                    <div className="grid grid-cols-3 gap-2">
                                        <button onClick={() => setSafPriceUsd(2000)} className={`text-xs py-2 rounded-lg border font-medium ${safPriceUsd === 2000 ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-500 border-slate-200'}`}>悲观 $2000</button>
                                        <button onClick={() => setSafPriceUsd(2200)} className={`text-xs py-2 rounded-lg border font-medium ${safPriceUsd === 2200 ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-500 border-slate-200'}`}>中性 $2200</button>
                                        <button onClick={() => setSafPriceUsd(2400)} className={`text-xs py-2 rounded-lg border font-medium ${safPriceUsd === 2400 ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-500 border-slate-200'}`}>乐观 $2400</button>
                                    </div>
                                </div>

                                {/* UCO 价格 */}
                                <div className="space-y-3 pb-6 border-b border-slate-100">
                                    <div className="flex justify-between items-center">
                                        <label className="text-sm font-bold text-orange-900">UCO 采购价 (¥)</label>
                                        <div className="flex items-center gap-1">
                                             {/* -100 按钮 */}
                                             <button onClick={() => setUcoPriceRmb(p => p - 100)} className="h-8 px-2 flex items-center justify-center bg-red-50 text-red-600 border border-red-100 rounded-lg text-xs font-bold hover:bg-red-100 active:scale-95 transition">-100</button>
                                            <button onClick={() => setUcoPriceRmb(p => p - 10)} className="w-8 h-8 flex items-center justify-center bg-slate-100 rounded-lg text-slate-600 hover:bg-slate-200 active:scale-95 transition">-</button>
                                            
                                            <input 
                                                type="number" step="10" 
                                                value={ucoPriceRmb} 
                                                onChange={(e) => setUcoPriceRmb(Number(e.target.value))}
                                                className="w-16 text-center py-1 font-bold text-lg text-orange-600 bg-orange-50 rounded-lg outline-none"
                                            />
                                            
                                            <button onClick={() => setUcoPriceRmb(p => p + 10)} className="w-8 h-8 flex items-center justify-center bg-slate-100 rounded-lg text-slate-600 hover:bg-slate-200 active:scale-95 transition">+</button>
                                            {/* +100 按钮 */}
                                            <button onClick={() => setUcoPriceRmb(p => p + 100)} className="h-8 px-2 flex items-center justify-center bg-green-50 text-green-600 border border-green-100 rounded-lg text-xs font-bold hover:bg-green-100 active:scale-95 transition">+100</button>
                                        </div>
                                    </div>
                                    <input 
                                        type="range" min="5000" max="8000" step="10" 
                                        value={ucoPriceRmb} 
                                        onChange={(e) => setUcoPriceRmb(Number(e.target.value))}
                                        className="w-full mt-2 orange-slider"
                                    />
                                </div>

                                {/* 副产品：石脑油 */}
                                <div className="space-y-3 pb-4 border-b border-slate-100 pt-2">
                                    <div className="flex justify-between items-center">
                                        <div className="flex flex-col">
                                            <label className="text-sm font-bold text-purple-900 flex items-center gap-1">
                                                副产品: 生物石脑油
                                            </label>
                                            <span className="text-[10px] text-purple-400">产量 4.3万吨 (SAF 37.3万吨)</span>
                                        </div>
                                        <div className="flex items-center gap-1">
                                            <input 
                                                type="number" step="10" 
                                                value={naphthaPriceRmb} 
                                                onChange={(e) => setNaphthaPriceRmb(Number(e.target.value))}
                                                className="w-16 text-center py-1 font-bold text-lg text-purple-600 bg-purple-50 rounded-lg outline-none"
                                            />
                                        </div>
                                    </div>
                                    <input 
                                        type="range" min="4000" max="9000" step="100" 
                                        value={naphthaPriceRmb} 
                                        onChange={(e) => setNaphthaPriceRmb(Number(e.target.value))}
                                        className="w-full mt-2 purple-slider"
                                    />
                                </div>

                                {/* 更多参数 */}
                                <div className="grid grid-cols-2 gap-4 pt-4">
                                    <div className="space-y-1">
                                        <label className="text-xs text-slate-500 block">汇率</label>
                                        <input type="number" step="0.01" value={exchangeRate} onChange={(e) => setExchangeRate(Number(e.target.value))} className="w-full p-2 border border-slate-200 rounded-lg text-sm font-medium focus:border-indigo-500 outline-none"/>
                                    </div>
                                    <div className="space-y-1">
                                        <label className="text-xs text-slate-500 block">收率 (Yield %)</label>
                                        <input type="number" value={yieldRate} onChange={(e) => setYieldRate(Number(e.target.value))} className="w-full p-2 border border-slate-200 rounded-lg text-sm font-medium focus:border-indigo-500 outline-none"/>
                                    </div>
                                    <div className="space-y-1">
                                        <label className="text-xs text-slate-500 block">加工成本 (¥)</label>
                                        <input type="number" step="100" value={processCost} onChange={(e) => setProcessCost(Number(e.target.value))} className="w-full p-2 border border-slate-200 rounded-lg text-sm font-medium focus:border-indigo-500 outline-none"/>
                                    </div>
                                    <div className="space-y-1">
                                        <label className="text-xs text-slate-500 block">综合税率系数</label>
                                        <input type="number" step="0.01" value={taxFactor} onChange={(e) => setTaxFactor(Number(e.target.value))} className="w-full p-2 border border-slate-200 rounded-lg text-sm font-medium focus:border-indigo-500 outline-none" placeholder="如1.13"/>
                                    </div>
                                    <div className="space-y-1 col-span-2">
                                        <label className="text-xs text-slate-500 block">上市公司权益比例 (%)</label>
                                        <input type="number" step="0.01" value={equityRatio} onChange={(e) => setEquityRatio(Number(e.target.value))} className="w-full p-2 border border-slate-200 rounded-lg text-sm font-medium focus:border-indigo-500 outline-none"/>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* 右侧：结果展示 */}
                        <div className="lg:col-span-7 space-y-6">
                            
                            {/* 单吨经济模型 */}
                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                <div className="bg-slate-50 px-5 py-3 border-b border-slate-200 flex justify-between items-center">
                                    <span className="font-semibold text-slate-700 text-sm flex items-center gap-2">
                                        <i data-lucide="dollar-sign" className="w-4 h-4"></i> 单吨综合模型 (成本抵扣法)
                                    </span>
                                    <span className={`text-xs font-bold px-2 py-1 rounded-md ${results.grossProfitPerTon > 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                        毛利率: {results.marginRate.toFixed(1)}%
                                    </span>
                                </div>
                                <div className="p-5 grid grid-cols-3 gap-2 text-center divide-x divide-slate-100">
                                    <div>
                                        <div className="text-xs text-slate-400 mb-1">SAF 售价 (¥)</div>
                                        <div className="text-lg font-bold text-slate-800">¥{fmt(results.safRevenueOnly)}</div>
                                        <div className="text-[10px] text-slate-400 font-medium">
                                            不含副产品
                                        </div>
                                    </div>
                                    <div className="relative group">
                                        <div className="text-xs text-slate-400 mb-1">净完全成本</div>
                                        <div className="text-lg font-bold text-red-600">¥{fmt(results.netCostPerTon)}</div>
                                        <div className="text-[10px] text-purple-600 font-medium">
                                            (已抵扣副产品 ¥{fmt(results.naphthaCredit)})
                                        </div>
                                    </div>
                                    <div>
                                        <div className="text-xs text-slate-400 mb-1">毛利</div>
                                        <div className={`text-lg font-bold ${results.grossProfitPerTon > 0 ? 'text-green-600' : 'text-red-600'}`}>
                                            {results.grossProfitPerTon > 0 ? '+' : ''}¥{fmt(results.grossProfitPerTon)}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* 利润预测仪表盘 (全口径) */}
                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-5">
                                <div className="flex items-center gap-2 mb-4 border-b border-slate-100 pb-2">
                                    <i data-lucide="bar-chart-3" className="w-5 h-5 text-indigo-600"></i>
                                    <span className="font-bold text-slate-700">项目利润 (亿元)</span>
                                </div>
                                <div className="grid grid-cols-3 gap-4">
                                    {/* 单月 */}
                                    <div className="bg-slate-50 rounded-xl p-3 text-center">
                                        <div className="text-xs text-slate-400 mb-1">单月 ({volumeMonthly.toFixed(1)}万吨)</div>
                                        <div className="text-xl font-bold text-slate-700">{results.monthlyProjectProfit.toFixed(2)}</div>
                                    </div>
                                    {/* 季度 */}
                                    <div className="bg-slate-50 rounded-xl p-3 text-center border border-blue-100">
                                        <div className="text-xs text-blue-400 mb-1">季度 ({volumeQuarterly.toFixed(1)}万吨)</div>
                                        <div className="text-xl font-bold text-blue-600">{results.quarterlyProjectProfit.toFixed(2)}</div>
                                    </div>
                                    {/* 全年 */}
                                    <div className="bg-slate-50 rounded-xl p-3 text-center">
                                        <div className="text-xs text-slate-400 mb-1">全年 ({volumeYearly}万吨)</div>
                                        <div className="text-xl font-bold text-slate-700">{results.annualProjectProfit.toFixed(2)}</div>
                                    </div>
                                </div>
                            </div>

                            {/* 归母净利与估值 */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {/* 归母净利 */}
                                <div className="bg-gradient-to-br from-indigo-600 to-purple-600 p-5 rounded-2xl shadow-lg text-white flex flex-col items-center justify-center">
                                    <div className="text-xs text-indigo-200 mb-1 flex items-center gap-1">
                                        归母毛利润
                                    </div>
                                    <div className="text-3xl font-extrabold">
                                        {results.attributableProfit.toFixed(2)} <span className="text-lg font-normal opacity-80">亿</span>
                                    </div>
                                    <div className="text-[10px] text-indigo-200 mt-1 opacity-80">按 {equityRatio}% 权益计算</div>
                                </div>

                                {/* PE估值 */}
                                <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 flex flex-col items-center justify-center">
                                    <div className="text-xs text-slate-500 mb-1">隐含动态 PE</div>
                                    <div className={`text-3xl font-bold ${results.peRatio > 0 && results.peRatio < 15 ? 'text-green-600' : 'text-slate-700'}`}>
                                        {results.peRatio > 0 ? results.peRatio.toFixed(1) : '∞'} <span className="text-sm font-normal text-slate-400">倍</span>
                                    </div>
                                    <div className="text-[10px] text-slate-400 mt-1">基于当前市值 {marketCap.toFixed(2)}亿</div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<JiaaoSafCalculator />);
    </script>
</body>
</html>